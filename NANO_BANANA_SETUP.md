# Nano Banana Pro Workflow Setup

This document describes the setup required for the "Nano Banana Pro" workflow on Comfy Cloud, which is used for generating video frame variations with consistent character and background.

## API Configuration

To use the Nano Banana workflow, you must configure the application to use **Dual API Endpoints**: one for the standard wrapper (local build) and one for the official Comfy Cloud API (for Nano Banana).

**Environment Variables (.env)**:
```env
# The Wrapper API (used for standard workflows)
COMFYUI_API_URL=https://comfy-api.ez-agi.com

# The Cloud API (used for Nano Banana / Uploads)
CLOUD_COMFY_API_URL=https://api.comfy.org/api/v1

# Authorization for Cloud API
COMFYUI_API_KEY=your_api_key_here
```

## Workflow Implementation

The Nano Banana workflow is implemented using **Raw Workflow JSON** injection rather than a stored Workflow ID. This allows direct control over the nodes using the official ComfyUI API (`/prompt` endpoint).

### Key Workflow Nodes

The system dynamically constructs a workflow JSON with the following key nodes:

1.  **Load Image (Node 11)**:
    *   Input: `image` (The filename of the image uploaded to `CLOUD_COMFY_API_URL`).
    *   This is the source frame (Frame 0).

2.  **Nano Banana Pro / GeminiImage2Node (Node 38)**:
    *   Input: `prompt` (The activity/pose description generated by the storyboard agent).
    *   Input: `images` (Linked to Node 11).
    *   Input: `seed` (Randomized for variation).
    *   Model: `gemini-3-pro-image-preview`.

3.  **Save Image (Node 30)**:
    *   Captures the output.

### Flow Description

1.  **Upload**: The system uploads the source image to `CLOUD_COMFY_API_URL/upload/image`.
2.  **Construct**: It builds the JSON payload, injecting the uploaded filename and the new prompt.
3.  **Queue**: It sends the JSON to `CLOUD_COMFY_API_URL/prompt`.
4.  **Poll**: It polls `CLOUD_COMFY_API_URL/history/{prompt_id}` until completion.
5.  **Download**: It downloads the result using `CLOUD_COMFY_API_URL/view`.

### Testing

A dedicated test script is available at `scripts/test_nano_banana.py` to verify this flow independently.
