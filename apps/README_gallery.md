# Results Gallery

## Description
The **Results Gallery** is a Streamlit-based application designed to manage, view, and organize the images generated by the AI workflows. It provides a visual interface for browsing the output directory, inspecting metadata (seeds, prompts), and performing batch operations like downloading or deleting files. It serves as the quality control and delivery hub for the project.

## Architecture / Processing Flow

1.  **Initialization**:
    *   The app initializes the `ImageLogsStorage` to connect to the SQLite database.
    *   It reads the `OUTPUT_DIR` from the global configuration.

2.  **Data Loading (`load_gallery_data`)**:
    *   **DB Query**: Fetches all completed execution records from the local SQLite database to retrieve metadata like "Persona" and "Execution ID".
    *   **File Scan**: Scans the `OUTPUT_DIR` for image files (`.png`, `.jpg`, etc.).
    *   **Merge**: matches physical files with their database records based on filenames.

3.  **User Interface (Streamlit)**:
    *   **Filtering**: Users can filter images by "Persona" (e.g., Jennie, Mika) or sort by date.
    *   **Grid View**: Displays images in a responsive grid.
    *   **Metadata**: On hovering or clicking "View Metadata", the app reads the image file header (using Pillow) to extract ComfyUI metadata (Seed, Prompt) and displays database records.

4.  **Actions**:
    *   **Selection**: Users select images to build a batch.
    *   **Download**: The app zips selected images (optionally including a `.txt` file with metadata for each) and provides a download link.
    *   **Approval**: Toggles an "Approved" state stored in a local JSON file (`approvals.json`) to mark high-quality outputs.
    *   **Maintenance**: "Delete Unused" compares the file list against the "Approved" list to bulk-delete rejected images.

## Functions/Features

*   **Gallery Grid**: Responsive grid layout with pagination to browse large collections of generated images.
*   **Metadata Inspector**: Extracts and displays hidden metadata from generated images, including the exact prompt and seed used by ComfyUI.
*   **Persona Filtering**: Filter results by the specific AI persona used during generation.
*   **Batch Download**: Select multiple images and download them as a single ZIP archive. Includes options to export prompts as text files.
*   **Approval System**: "Like/Approve" images to persist a curated list of favorites.
*   **Maintenance Tools**: One-click cleanup to delete all images that haven't been approved/curated.
*   **Reference Image**: Displays the source/reference image used (if applicable) alongside the result.

## Backlog

*   **Authentication**: Add user login to prevent unauthorized deletions.
*   **Tagging System**: Allow custom tags (e.g., "NSFW", "Artistic") beyond just "Approved".
*   **Image Editor**: Basic in-app cropping or adjustment tools.
*   **Cloud Sync**: Button to push approved images directly to Google Cloud Storage.

## Deployment Infrastructure

*   **Container**: Docker container based on `python:3.11-slim`.
*   **Service Name**: `gallery` (in `docker-compose.yml`).
*   **Port**: Exposed on port **8502** (mapped from container port 8501).
*   **Volumes**: Mounts the local `results/` directory to `/app/results` to ensure file persistence.

## Secrets/Keys

This application primarily relies on local file access and the SQLite database.
*   `DB_*` (DB_HOST, DB_USER, etc.) - For connecting to the logs database (if externalized).
*   `GCS_*` - (Optional) If remote metadata fetching or future cloud sync is enabled.

## Development Environment

*   **Language**: Python 3.11
*   **Framework**: Streamlit
*   **Key Libraries**:
    *   `streamlit`: UI framework.
    *   `Pillow`: Image processing and metadata extraction.
    *   `pandas`: Data manipulation.
    *   `zipfile`: Creating archives.
